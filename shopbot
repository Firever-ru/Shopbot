import logging
import sqlite3
import asyncio
from datetime import datetime, timedelta

from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import (
    ReplyKeyboardMarkup,
    KeyboardButton,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    InputMediaPhoto,
)
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

#set

API_TOKEN = ""          #token
ADMIN_ID = ...                   #id admin
SUPPORT_USERNAME = "Username"          #support id
CHANNEL_LINK = "https://t.me/channel"   #cannel

ADMIN_PASSWORD = ""            #password admin panel
ADMIN_SESSION_TTL_MINUTES = 

REVIEWS_CHANNEL_USERNAME = "Username"         #username cannel reviews
REVIEWS_CHANNEL = f"@Username"  #reviews
REVIEWS_CHANNEL_LINK = f"https://t.me/channel"  #reviews channel

CARD_NUMBER = ""
CARD_NAME = "First Name Last name"

#page ap
ADMIN_ORDERS_PAGE_SIZE = 

#rus status
STATUS_WAIT = "–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã"
STATUS_PAID = "–û–ø–ª–∞—á–µ–Ω"
STATUS_SENT = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω"
STATUS_RECEIVED = "–ü–æ–ª—É—á–µ–Ω"
STATUS_DECLINED = "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ"  


logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot, storage=MemoryStorage())

AUTH_ADMINS = {}

def authorize_admin(user_id: int):
    AUTH_ADMINS[user_id] = datetime.now() + timedelta(minutes=ADMIN_SESSION_TTL_MINUTES)

def is_admin_authorized(user_id: int) -> bool:
    exp = AUTH_ADMINS.get(user_id)
    return bool(exp and datetime.now() < exp)

# sql

def init_db():
    conn = sqlite3.connect("shop.db")
    cur = conn.cursor()
    cur.execute("""
    CREATE TABLE IF NOT EXISTS catalog (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        photo TEXT,            -- file_id —Ñ–æ—Ç–æ –≤ Telegram
        description TEXT,      -- –æ–ø–∏—Å–∞–Ω–∏–µ / –Ω–∞–∑–≤–∞–Ω–∏–µ
        price INTEGER,         -- —Ü–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
        sizes TEXT             -- —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä (S,M,L,XL / 42,44,...)
    )
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS orders (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        username TEXT,
        product_id INTEGER,
        size TEXT,
        status TEXT,
        proof TEXT,            -- –ø–æ–¥–ø–∏—Å—å –∫ —á–µ–∫—É (–∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
        address TEXT,          -- –∞–¥—Ä–µ—Å (CDEK/–ü–æ—á—Ç–∞)
        track TEXT,            -- —Ç—Ä–µ–∫-–∫–æ–¥
        received_date TEXT     -- –¥–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è "–ü–æ–ª—É—á–µ–Ω"
    )
    """)

    try:
        cur.execute("ALTER TABLE orders ADD COLUMN delivery TEXT")
    except sqlite3.OperationalError:
        pass  
    conn.commit()
    conn.close()

init_db()

#menu

def get_main_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("–ö–∞—Ç–∞–ª–æ–≥ –æ–¥–µ–∂–¥—ã"))
    kb.add(KeyboardButton("–ú–æ–∏ –∑–∞–∫–∞–∑—ã"))
    kb.add(KeyboardButton("–û—Ç–∑—ã–≤—ã"), KeyboardButton("–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤"))
    kb.add(KeyboardButton("–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π"))
    kb.add(KeyboardButton("–¢–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª"))
    return kb

def get_admin_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton("–í—ã–ª–æ–∂–∏—Ç—å –æ–¥–µ–∂–¥—É"))
    kb.add(KeyboardButton("–î–µ–π—Å—Ç–≤—É—é—â–∏–π –∫–∞—Ç–∞–ª–æ–≥"))
    kb.add(KeyboardButton("–ó–∞–∫–∞–∑—ã"))
    kb.add(KeyboardButton("–û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤"))
    kb.add(KeyboardButton("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤"))
    return kb

#fsm

class AddProduct(StatesGroup):
    photo = State()
    price = State()
    sizes = State()

class EditProduct(StatesGroup):
    desc = State()
    price = State()
    sizes = State()

class Broadcast(StatesGroup):
    text = State()

class AddressInput(StatesGroup):
    waiting_for_address = State()  

class TrackInput(StatesGroup):
    waiting_for_track = State()    

class AdminLogin(StatesGroup):
    waiting_for_password = State()

class ReviewInput(StatesGroup):
    waiting_for_review = State()

#dr

def db_conn():
    return sqlite3.connect("shop.db")

def get_product_by_offset(offset: int):
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT id, photo, description, price, sizes FROM catalog ORDER BY id LIMIT 1 OFFSET ?", (offset,))
    row = cur.fetchone()
    conn.close()
    return row

def count_products():
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT COUNT(*) FROM catalog")
    total = cur.fetchone()[0]
    conn.close()
    return total

def normalize_sizes(text: str) -> str:
    t = text.replace(" ", "").upper()
    if "," in t:
        return t
    parts = []
    buf = ""
    for ch in t:
        buf += ch
        if len(buf) >= 2 and (buf.endswith("S") or buf.endswith("M") or buf.endswith("L") or buf.isdigit()):
            parts.append(buf)
            buf = ""
    if buf:
        parts.append(buf)
    return ",".join(parts) if parts else t

def main_menu_text() -> str:
    return "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω *OkSEX*!\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ:"

def admin_only(message: types.Message) -> bool:
    return is_admin_authorized(message.from_user.id)

async def guard_admin_cb(call: types.CallbackQuery) -> bool:
    if not is_admin_authorized(call.from_user.id):
        await call.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –í–≤–µ–¥–∏—Ç–µ /ap.", show_alert=True)
        return False
    return True

#command

@dp.message_handler(commands=["start"])
async def cmd_start(message: types.Message):
    await message.answer(main_menu_text(), reply_markup=get_main_menu(), parse_mode="Markdown")

@dp.message_handler(commands=["ap"])
async def cmd_admin(message: types.Message):
    await AdminLogin.waiting_for_password.set()
    await message.answer("üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª–∏:")

@dp.message_handler(state=AdminLogin.waiting_for_password, content_types=["text"])
async def admin_check_password(message: types.Message, state: FSMContext):
    if message.text.strip() == ADMIN_PASSWORD:
        authorize_admin(message.from_user.id)
        await state.finish()
        await message.answer("üîë –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω. –ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å:", reply_markup=get_admin_menu())
    else:
        await state.finish()
        await message.answer("‚õî –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.")

#menu 

@dp.message_handler(lambda m: m.text == "–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π")
async def client_support(message: types.Message):
    await message.answer(f"üìû –°–≤—è–∑—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º: @{SUPPORT_USERNAME}")

@dp.message_handler(lambda m: m.text == "–¢–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª")
async def client_channel(message: types.Message):
    await message.answer(f"üì¢ –ù–∞—à –∫–∞–Ω–∞–ª: {CHANNEL_LINK}")

@dp.message_handler(lambda m: m.text == "–û—Ç–∑—ã–≤—ã")
async def client_reviews_link(message: types.Message):
    await message.answer(f"üìù –û—Ç–∑—ã–≤—ã: {REVIEWS_CHANNEL_LINK}")

@dp.message_handler(lambda m: m.text == "–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤")
async def client_write_review(message: types.Message):
    await message.answer("‚úçÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–º–æ–∂–Ω–æ —Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ) ‚Äî —è –ø–µ—Ä–µ—à–ª—é –µ–≥–æ –≤ –Ω–∞—à –∫–∞–Ω–∞–ª.")
    await ReviewInput.waiting_for_review.set()

@dp.message_handler(state=ReviewInput.waiting_for_review, content_types=types.ContentTypes.ANY)
async def client_review_forward(message: types.Message, state: FSMContext):
    try:
        await bot.forward_message(chat_id=REVIEWS_CHANNEL, from_chat_id=message.chat.id, message_id=message.message_id)
        await message.answer("‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª.")
    except Exception as e:
        await message.answer(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–æ–º –≤ {REVIEWS_CHANNEL}. –û—à–∏–±–∫–∞: {e}")
    await state.finish()

#add

@dp.message_handler(lambda m: m.text == "–í—ã–ª–æ–∂–∏—Ç—å –æ–¥–µ–∂–¥—É")
async def add_product_start(message: types.Message):
    if not admin_only(message):
        return
    await message.answer("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ *—Ñ–æ—Ç–æ* —Ç–æ–≤–∞—Ä–∞ —Å –ø–æ–¥–ø–∏—Å—å—é (–Ω–∞–∑–≤–∞–Ω–∏–µ/–æ–ø–∏—Å–∞–Ω–∏–µ).", parse_mode="Markdown")
    await AddProduct.photo.set()

@dp.message_handler(content_types=["photo"], state=AddProduct.photo)
async def add_product_photo(message: types.Message, state: FSMContext):
    photo_id = message.photo[-1].file_id
    description = message.caption if message.caption else "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"
    await state.update_data(photo=photo_id, description=description)
    await message.answer("üí∞ –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):")
    await AddProduct.price.set()

@dp.message_handler(lambda m: m.text.isdigit(), state=AddProduct.price)
async def add_product_price(message: types.Message, state: FSMContext):
    await state.update_data(price=int(message.text))
    await message.answer("üìè –í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä—ã *–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤*, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: `S,M,L,XL`):", parse_mode="Markdown")
    await AddProduct.sizes.set()

@dp.message_handler(state=AddProduct.sizes)
async def add_product_sizes(message: types.Message, state: FSMContext):
    data = await state.get_data()
    sizes = normalize_sizes(message.text)
    conn = db_conn()
    cur = conn.cursor()
    cur.execute(
        "INSERT INTO catalog (photo, description, price, sizes) VALUES (?, ?, ?, ?)",
        (data["photo"], data["description"], data["price"], sizes)
    )
    conn.commit()
    conn.close()
    await state.finish()
    await message.answer("‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥.", reply_markup=get_admin_menu())

#catalog

def catalog_keyboard(page: int, total: int, product_id: int) -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.row(
        InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"cat_prev_{page}"),
        InlineKeyboardButton("‚û°Ô∏è", callback_data=f"cat_next_{page}")
    )
    kb.add(InlineKeyboardButton("üõí –ó–∞–∫–∞–∑–∞—Ç—å", callback_data=f"order_{product_id}"))
    return kb

@dp.message_handler(lambda m: m.text == "–ö–∞—Ç–∞–ª–æ–≥ –æ–¥–µ–∂–¥—ã")
async def show_catalog(message: types.Message):
    total = count_products()
    if total == 0:
        await message.answer("üì¶ –ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ.")
        return
    row = get_product_by_offset(0)
    prod_id, photo, desc, price, sizes = row
    await message.answer_photo(
        photo,
        caption=f"{desc}\n\nüí∞ –¶–µ–Ω–∞: {price} —Ä—É–±.\nüìè –†–∞–∑–º–µ—Ä—ã: {sizes}",
        reply_markup=catalog_keyboard(0, total, prod_id)
    )

@dp.callback_query_handler(lambda c: c.data.startswith("cat_prev_") or c.data.startswith("cat_next_"))
async def catalog_paginate(call: types.CallbackQuery):
    parts = call.data.split("_")
    direction, current_page = parts[1], int(parts[2])
    total = count_products()
    if total == 0:
        await call.answer("–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç.")
        return
    if direction == "prev":
        new_page = max(0, current_page - 1)
    else:
        new_page = min(total - 1, current_page + 1)
    row = get_product_by_offset(new_page)
    prod_id, photo, desc, price, sizes = row
    try:
        await call.message.edit_media(
            InputMediaPhoto(photo, caption=f"{desc}\n\nüí∞ –¶–µ–Ω–∞: {price} —Ä—É–±.\nüìè –†–∞–∑–º–µ—Ä—ã: {sizes}")
        )
        await call.message.edit_reply_markup(reply_markup=catalog_keyboard(new_page, total, prod_id))
    except Exception:
        await call.message.answer_photo(
            photo,
            caption=f"{desc}\n\nüí∞ –¶–µ–Ω–∞: {price} —Ä—É–±.\nüìè –†–∞–∑–º–µ—Ä—ã: {sizes}",
            reply_markup=catalog_keyboard(new_page, total, prod_id)
        )
    await call.answer()

#order

@dp.callback_query_handler(lambda c: c.data.startswith("order_"))
async def order_pick_size(call: types.CallbackQuery):
    product_id = int(call.data.split("_")[1])
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT sizes, price, description FROM catalog WHERE id=?", (product_id,))
    row = cur.fetchone()
    conn.close()
    if not row:
        await call.answer("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    sizes_str, price, desc = row
    sizes = [s.strip() for s in sizes_str.split(",") if s.strip()]
    kb = InlineKeyboardMarkup()
    for s in sizes:
        kb.add(InlineKeyboardButton(s, callback_data=f"choose_{product_id}_{s}"))
    await call.message.answer(
        f"üßæ {desc}\n"
        f"üí∞ –¶–µ–Ω–∞: {price} —Ä—É–±. (+ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏, —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏)\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä:",
        reply_markup=kb
    )
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("choose_"))
async def choose_size(call: types.CallbackQuery):
    _, product_id, size = call.data.split("_")
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT price, description FROM catalog WHERE id=?", (product_id,))
    row = cur.fetchone()
    if not row:
        conn.close()
        await call.answer("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    price, desc = row

    
    cur.execute(
        "INSERT INTO orders (user_id, username, product_id, size, status) VALUES (?, ?, ?, ?, ?)",
        (call.from_user.id, call.from_user.username, int(product_id), size, STATUS_WAIT)
    )
    order_id = cur.lastrowid
    conn.commit()
    conn.close()

    
    kb_deliv = InlineKeyboardMarkup().row(
        InlineKeyboardButton("–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏", callback_data=f"delivery_{order_id}_POST"),
        InlineKeyboardButton("CDEK (–¥–æ—Ä–æ–∂–µ)", callback_data=f"delivery_{order_id}_CDEK")
    )

    await call.message.answer(
        f"üßæ –ó–∞–∫–∞–∑ ‚Ññ{order_id}\n"
        f"–¢–æ–≤–∞—Ä: {desc}\n–†–∞–∑–º–µ—Ä: {size}\n"
        f"üí∞ –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: {price} —Ä—É–±. (+ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏, —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏)\n\n"
        f"–û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º:\n"
        f"üí≥ –ö–∞—Ä—Ç–∞: {CARD_NUMBER}\n"
        f"üë§ –î–µ—Ä–∂–∞—Ç–µ–ª—å: {CARD_NAME}\n\n"
        f"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ *–°–ö–†–ò–ù–®–û–¢ –ø–µ—Ä–µ–≤–æ–¥–∞* –∏ *–∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è* –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (—Å–∫—Ä–∏–Ω—à–æ—Ç + –ø–æ–¥–ø–∏—Å—å).\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è:",
        reply_markup=kb_deliv,
        parse_mode="Markdown"
    )
    await call.answer()


@dp.callback_query_handler(lambda c: c.data.startswith("delivery_"))
async def set_delivery(call: types.CallbackQuery):
    _, order_id_str, method = call.data.split("_")
    order_id = int(order_id_str)
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT user_id, status FROM orders WHERE id=?", (order_id,))
    row = cur.fetchone()
    if not row:
        conn.close()
        await call.answer("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    user_id, status = row
    if call.from_user.id != user_id:
        conn.close()
        await call.answer("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.", show_alert=True)
        return

    cur.execute("UPDATE orders SET delivery=? WHERE id=?", (method, order_id))
    conn.commit()
    conn.close()

    human = "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏" if method == "POST" else "CDEK (–¥–æ—Ä–æ–∂–µ)"
    await call.answer(f"–í—ã–±—Ä–∞–Ω–æ: {human}")

    
    if status == STATUS_PAID:
        client_state = dp.current_state(chat=user_id, user=user_id)
        await client_state.set_state(AddressInput.waiting_for_address.state)
        await client_state.update_data(order_id=order_id)
        if method == "CDEK":
            await bot.send_message(user_id, "üìç –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ *–ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –æ—Ç–¥–µ–ª–µ–Ω–∏—è CDEK* (–≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º) –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.", parse_mode="Markdown")
        else:
            await bot.send_message(user_id, "üìç –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ *–§–ò–û, –∏–Ω–¥–µ–∫—Å –∏ –ø–æ–ª–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å* –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ü–æ—á—Ç–æ–π –†–æ—Å—Å–∏–∏ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.", parse_mode="Markdown")


@dp.message_handler(content_types=["photo"])
async def receive_payment_proof(message: types.Message):
    conn = db_conn()
    cur = conn.cursor()
    cur.execute(
        "SELECT id FROM orders WHERE user_id=? AND status=? ORDER BY id DESC LIMIT 1",
        (message.from_user.id, STATUS_WAIT)
    )
    row = cur.fetchone()
    if not row:
        conn.close()
        return  
    order_id = row[0]

    proof_caption = message.caption if message.caption else "–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∏"
    cur.execute("UPDATE orders SET proof=? WHERE id=?", (proof_caption, order_id))
    conn.commit()
    conn.close()

  
    kb = InlineKeyboardMarkup()
    kb.row(
        InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"confirm_{order_id}"),
        InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"decline_{order_id}")
    )
    await bot.send_photo(
        ADMIN_ID,
        message.photo[-1].file_id,
        caption=f"üí∏ –ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂\n–ó–∞–∫–∞–∑ ‚Ññ{order_id}\n–û—Ç @{message.from_user.username}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {proof_caption}",
        reply_markup=kb
    )
    await message.answer("üì© –ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü—É. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")

@dp.callback_query_handler(lambda c: c.data.startswith("confirm_") or c.data.startswith("decline_"))
async def admin_confirm_or_decline(call: types.CallbackQuery):
    if not await guard_admin_cb(call):
        return

    order_id = int(call.data.split("_")[1])

    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT user_id FROM orders WHERE id=?", (order_id,))
    row = cur.fetchone()
    if not row:
        conn.close()
        await call.answer("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return
    user_id = row[0]

    if call.data.startswith("decline_"):
        cur.execute("UPDATE orders SET status=? WHERE id=?", (STATUS_DECLINED, order_id))
        conn.commit()
        conn.close()
        await bot.send_message(user_id, "‚ùå –û–ø–ª–∞—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.", reply_markup=get_main_menu())
        try:
            await call.message.edit_caption(call.message.caption + "\n\n‚ùå –û–¢–ö–õ–û–ù–ï–ù–û")
        except Exception:
            pass
        await call.answer("–û–ø–ª–∞—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.")
        return

    cur.execute("UPDATE orders SET status=? WHERE id=?", (STATUS_PAID, order_id))
    cur.execute("SELECT delivery FROM orders WHERE id=?", (order_id,))
    drow = cur.fetchone()
    delivery = drow[0] if drow else None
    conn.commit()
    conn.close()

    if not delivery:
        kb_deliv = InlineKeyboardMarkup().row(
            InlineKeyboardButton("–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏", callback_data=f"delivery_{order_id}_POST"),
            InlineKeyboardButton("CDEK (–¥–æ—Ä–æ–∂–µ)", callback_data=f"delivery_{order_id}_CDEK")
        )
        await bot.send_message(
            user_id,
            "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n\n–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑:",
            reply_markup=kb_deliv
        )
    else:
        client_state = dp.current_state(chat=user_id, user=user_id)
        await client_state.set_state(AddressInput.waiting_for_address.state)
        await client_state.update_data(order_id=order_id)
        if delivery == "CDEK":
            await bot.send_message(
                user_id,
                "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ *–ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –æ—Ç–¥–µ–ª–µ–Ω–∏—è CDEK* (–≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º) –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.",
                parse_mode="Markdown"
            )
        else:
            await bot.send_message(
                user_id,
                "‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ *–§–ò–û, –∏–Ω–¥–µ–∫—Å –∏ –ø–æ–ª–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å* –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ü–æ—á—Ç–æ–π –†–æ—Å—Å–∏–∏ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.",
                parse_mode="Markdown"
            )

    try:
        await call.message.edit_caption(call.message.caption + "\n\n‚úÖ –û–ü–õ–ê–ß–ï–ù–û")
    except Exception:
        pass
    await call.answer("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.")

@dp.message_handler(state=AddressInput.waiting_for_address, content_types=["text"])
async def receive_address(message: types.Message, state: FSMContext):
    data = await state.get_data()
    order_id = data.get("order_id")
    if not order_id:
        await state.finish()
        return

    conn = db_conn()
    cur = conn.cursor()
    cur.execute("UPDATE orders SET address=? WHERE id=?", (message.text.strip(), order_id))
    cur.execute("SELECT delivery FROM orders WHERE id=?", (order_id,))
    drow = cur.fetchone()
    delivery = drow[0] if drow else None
    conn.commit()
    conn.close()

    await message.answer("üì¶ –ê–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Äî –º—ã –ø—Ä–∏—à–ª—ë–º —Ç—Ä–µ–∫-–∫–æ–¥.")
    await bot.send_message(ADMIN_ID, f"üì¶ –ó–∞–∫–∞–∑ ‚Ññ{order_id}\nüöö –î–æ—Å—Ç–∞–≤–∫–∞: {'CDEK' if delivery=='CDEK' else '–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏' if delivery=='POST' else '–Ω–µ –≤—ã–±—Ä–∞–Ω–æ'}\n–ê–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞: {message.text.strip()}")
    await state.finish()

#my order

@dp.message_handler(lambda m: m.text == "–ú–æ–∏ –∑–∞–∫–∞–∑—ã")
async def my_orders(message: types.Message):
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("""
        SELECT id, product_id, size, status, track, delivery
        FROM orders
        WHERE user_id=?
        ORDER BY id DESC
    """, (message.from_user.id,))
    orders = cur.fetchall()
    conn.close()

    if not orders:
        await message.answer("üßæ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.")
        return

    for order_id, product_id, size, status, track, delivery in orders:
        conn = db_conn()
        cur = conn.cursor()
        cur.execute("SELECT description FROM catalog WHERE id=?", (product_id,))
        prod = cur.fetchone()
        conn.close()
        name = prod[0] if prod else f"–¢–æ–≤–∞—Ä #{product_id}"

        delivery_name = "CDEK" if delivery == "CDEK" else "–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏" if delivery == "POST" else "–Ω–µ –≤—ã–±—Ä–∞–Ω"
        text = (
            f"üßæ –ó–∞–∫–∞–∑ ‚Ññ{order_id}\n"
            f"üì¶ {name}\n"
            f"üìè –†–∞–∑–º–µ—Ä: {size}\n"
            f"üöö –î–æ—Å—Ç–∞–≤–∫–∞: {delivery_name}\n"
            f"üìå –°—Ç–∞—Ç—É—Å: {status}"
        )
        if track:
            text += f"\nüìÆ –¢—Ä–µ–∫-–∫–æ–¥: {track}"

        kb = None
        if status == STATUS_SENT:
            kb = InlineKeyboardMarkup().add(
                InlineKeyboardButton("‚úÖ –ó–∞–∫–∞–∑ –ø–æ–ª—É—á–µ–Ω", callback_data=f"received_{order_id}")
            )
        await message.answer(text, reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("received_"))
async def mark_order_received(call: types.CallbackQuery):
    order_id = int(call.data.split("_")[1])
    conn = db_conn()
    cur = conn.cursor()
    cur.execute(
        "UPDATE orders SET status=?, received_date=? WHERE id=?",
        (STATUS_RECEIVED, datetime.now().strftime("%Y-%m-%d %H:%M:%S"), order_id)
    )
    conn.commit()
    conn.close()
    await call.message.answer("üéâ –°–ø–∞—Å–∏–±–æ! –ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ *–ø–æ–ª—É—á–µ–Ω*. –û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ 2 –¥–Ω—è.", parse_mode="Markdown")
    try:
        await call.message.edit_reply_markup()
    except Exception:
        pass
    await call.answer()

#order

def order_admin_keyboard(order_id: int, status: str, username: str) -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    if status == STATUS_PAID:
        kb.add(InlineKeyboardButton("üìÆ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω", callback_data=f"sent_{order_id}"))
    if status not in (STATUS_DECLINED, STATUS_RECEIVED, STATUS_CANCELLED):
        kb.add(InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_{order_id}"))
    kb.add(InlineKeyboardButton("üìû –°–≤—è–∑–∞—Ç—å—Å—è", callback_data=f"contact_{order_id}"))
    return kb

@dp.message_handler(lambda m: m.text == "–ó–∞–∫–∞–∑—ã")
async def admin_orders(message: types.Message):
    if not admin_only(message):
        return

    conn = db_conn()
    cur = conn.cursor()
    cur.execute("""
        SELECT id, user_id, username, product_id, size, status
        FROM orders
        WHERE status IN (?,?)
        ORDER BY id DESC
        LIMIT ?
    """, (STATUS_PAID, STATUS_SENT, ADMIN_ORDERS_PAGE_SIZE))
    rows = cur.fetchall()
    conn.close()

    if not rows:
        await message.answer("üì≠ –û–ø–ª–∞—á–µ–Ω–Ω—ã—Ö/–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.")
        return

    for order_id, user_id, username, product_id, size, status in rows:
        conn = db_conn()
        cur = conn.cursor()
        cur.execute("SELECT description FROM catalog WHERE id=?", (product_id,))
        prod = cur.fetchone()
        conn.close()
        name = prod[0] if prod else f"–¢–æ–≤–∞—Ä #{product_id}"
        text = f"üßæ –ó–∞–∫–∞–∑ ‚Ññ{order_id}\nüë§ @{username}\nüì¶ {name}\nüìè –†–∞–∑–º–µ—Ä: {size}\nüìå –°—Ç–∞—Ç—É—Å: {status}"
        await message.answer(text, reply_markup=order_admin_keyboard(order_id, status, username))

@dp.callback_query_handler(lambda c: c.data.startswith("sent_"))
async def admin_sent(call: types.CallbackQuery, state: FSMContext):
    if not await guard_admin_cb(call):
        return
    order_id = int(call.data.split("_")[1])

    await TrackInput.waiting_for_track.set()
    await state.update_data(order_id=order_id)

    await call.message.answer(f"üìÆ –í–≤–µ–¥–∏—Ç–µ *—Ç—Ä–µ–∫-–∫–æ–¥* –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Ññ{order_id}:", parse_mode="Markdown")
    await call.answer()

@dp.message_handler(state=TrackInput.waiting_for_track, content_types=["text"])
async def admin_save_track(message: types.Message, state: FSMContext):
    if not admin_only(message):
        await state.finish()
        return
    data = await state.get_data()
    order_id = data.get("order_id")
    track = message.text.strip()

    conn = db_conn()
    cur = conn.cursor()
    cur.execute("UPDATE orders SET status=?, track=? WHERE id=?", (STATUS_SENT, track, order_id))
    cur.execute("SELECT user_id FROM orders WHERE id=?", (order_id,))
    row = cur.fetchone()
    conn.commit()
    conn.close()

    if row:
        user_id = row[0]
        await bot.send_message(user_id, f"üì¶ –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} *–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω*!\nüìÆ –¢—Ä–µ–∫-–∫–æ–¥: `{track}`",
                               parse_mode="Markdown")

    await message.answer("‚úÖ –¢—Ä–µ–∫-–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –∫–ª–∏–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª—ë–Ω.")
    await state.finish()

@dp.callback_query_handler(lambda c: c.data.startswith("contact_"))
async def admin_contact(call: types.CallbackQuery):
    if not await guard_admin_cb(call):
        return
    order_id = int(call.data.split("_")[1])
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT username FROM orders WHERE id=?", (order_id,))
    row = cur.fetchone()
    conn.close()
    if row and row[0]:
        await call.message.answer(f"üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º: @{row[0]}")
    else:
        await call.message.answer("‚ùå –£ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç username.")
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("cancel_"))
async def admin_cancel(call: types.CallbackQuery):
    if not await guard_admin_cb(call):
        return
    order_id = int(call.data.split("_")[1])

    conn = db_conn()
    cur = conn.cursor()
    cur.execute("UPDATE orders SET status=? WHERE id=?", (STATUS_CANCELLED, order_id))
    cur.execute("SELECT user_id FROM orders WHERE id=?", (order_id,))
    row = cur.fetchone()
    conn.commit()
    conn.close()

    if row:
        await bot.send_message(row[0], f"‚ùå –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} –±—ã–ª *–æ—Ç–º–µ–Ω—ë–Ω* –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.", parse_mode="Markdown")
    await call.message.answer("–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω.")
    await call.answer()


@dp.message_handler(lambda m: m.text == "–û–ø–æ–≤–µ—Å—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤")
async def start_broadcast(message: types.Message):
    if not admin_only(message):
        return
    await message.answer("‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏:")
    await Broadcast.text.set()

@dp.message_handler(state=Broadcast.text, content_types=["text"])
async def send_broadcast(message: types.Message, state: FSMContext):
    if not admin_only(message):
        await state.finish()
        return
    text = message.text
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT DISTINCT user_id FROM orders")
    users = [row[0] for row in cur.fetchall()]
    conn.close()
    sent = 0
    for uid in users:
        try:
            await bot.send_message(uid, f"üì¢ –û–ø–æ–≤–µ—â–µ–Ω–∏–µ:\n\n{text}")
            sent += 1
        except Exception:
            pass
    await message.answer(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}.")
    await state.finish()

@dp.message_handler(lambda m: m.text == "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤")
async def clear_history(message: types.Message):
    if not admin_only(message):
        return
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("DELETE FROM orders WHERE status IN (?, ?, ?)", (STATUS_RECEIVED, STATUS_CANCELLED, STATUS_DECLINED))
    deleted = cur.rowcount
    conn.commit()
    conn.close()
    await message.answer(f"üóë –£–¥–∞–ª–µ–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤: {deleted}")


def admin_catalog_keyboard(prod_id: int, page: int, total: int) -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("‚úè –ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ", callback_data=f"editdesc_{prod_id}"))
    kb.add(InlineKeyboardButton("üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É", callback_data=f"editprice_{prod_id}"))
    kb.add(InlineKeyboardButton("üìè –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã", callback_data=f"editsize_{prod_id}"))
    kb.add(InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"delask_{prod_id}"))
    kb.row(
        InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"aprev_{page}"),
        InlineKeyboardButton("‚û°Ô∏è", callback_data=f"anext_{page}")
    )
    return kb

@dp.message_handler(lambda m: m.text == "–î–µ–π—Å—Ç–≤—É—é—â–∏–π –∫–∞—Ç–∞–ª–æ–≥")
async def admin_catalog(message: types.Message):
    if not admin_only(message):
        return
    total = count_products()
    if total == 0:
        await message.answer("‚ùå –ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç.")
        return
    row = get_product_by_offset(0)
    prod_id, photo, desc, price, sizes = row
    await message.answer_photo(
        photo,
        caption=f"#{prod_id} {desc}\nüí∞ {price} —Ä—É–±.\nüìè {sizes}",
        reply_markup=admin_catalog_keyboard(prod_id, 0, total)
    )

@dp.callback_query_handler(lambda c: c.data.startswith("aprev_") or c.data.startswith("anext_"))
async def admin_catalog_paginate(call: types.CallbackQuery):
    if not await guard_admin_cb(call):
        return
    total = count_products()
    if total == 0:
        await call.answer("–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç.")
        return
    parts = call.data.split("_")
    direction, current_page = parts[0], int(parts[1])
    if direction == "aprev":
        new_page = max(0, current_page - 1)
    else:
        new_page = min(total - 1, current_page + 1)
    row = get_product_by_offset(new_page)
    prod_id, photo, desc, price, sizes = row
    try:
        await call.message.edit_media(InputMediaPhoto(photo, caption=f"#{prod_id} {desc}\nüí∞ {price} —Ä—É–±.\nüìè {sizes}"))
        await call.message.edit_reply_markup(reply_markup=admin_catalog_keyboard(prod_id, new_page, total))
    except Exception:
        await call.message.answer_photo(
            photo,
            caption=f"#{prod_id} {desc}\nüí∞ {price} —Ä—É–±.\nüìè {sizes}",
            reply_markup=admin_catalog_keyboard(prod_id, new_page, total)
        )
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("editdesc_"))
async def edit_desc_start(call: types.CallbackQuery, state: FSMContext):
    if not await guard_admin_cb(call):
        return
    prod_id = int(call.data.split("_")[1])
    await state.update_data(prod_id=prod_id)
    await call.message.answer("‚úè –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:")
    await EditProduct.desc.set()
    await call.answer()

@dp.message_handler(state=EditProduct.desc, content_types=["text"])
async def edit_desc_save(message: types.Message, state: FSMContext):
    if not admin_only(message):
        await state.finish()
        return
    data = await state.get_data()
    prod_id = data["prod_id"]
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("UPDATE catalog SET description=? WHERE id=?", (message.text, prod_id))
    conn.commit()
    conn.close()
    await state.finish()
    await message.answer("‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.")

@dp.callback_query_handler(lambda c: c.data.startswith("editprice_"))
async def edit_price_start(call: types.CallbackQuery, state: FSMContext):
    if not await guard_admin_cb(call):
        return
    prod_id = int(call.data.split("_")[1])
    await state.update_data(prod_id=prod_id)
    await call.message.answer("üí∞ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):")
    await EditProduct.price.set()
    await call.answer()

@dp.message_handler(state=EditProduct.price, content_types=["text"])
async def edit_price_save(message: types.Message, state: FSMContext):
    if not admin_only(message):
        await state.finish()
        return
    if not message.text.isdigit():
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 2499")
        return
    data = await state.get_data()
    prod_id = data["prod_id"]
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("UPDATE catalog SET price=? WHERE id=?", (int(message.text), prod_id))
    conn.commit()
    conn.close()
    await state.finish()
    await message.answer("‚úÖ –¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.")

@dp.callback_query_handler(lambda c: c.data.startswith("editsize_"))
async def edit_sizes_start(call: types.CallbackQuery, state: FSMContext):
    if not await guard_admin_cb(call):
        return
    prod_id = int(call.data.split("_")[1])
    await state.update_data(prod_id=prod_id)
    await call.message.answer("üìè –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: S,M,L,XL):")
    await EditProduct.sizes.set()
    await call.answer()

@dp.message_handler(state=EditProduct.sizes, content_types=["text"])
async def edit_sizes_save(message: types.Message, state: FSMContext):
    if not admin_only(message):
        await state.finish()
        return
    sizes = normalize_sizes(message.text)
    data = await state.get_data()
    prod_id = data["prod_id"]
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("UPDATE catalog SET sizes=? WHERE id=?", (sizes, prod_id))
    conn.commit()
    conn.close()
    await state.finish()
    await message.answer("‚úÖ –†–∞–∑–º–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.")

@dp.callback_query_handler(lambda c: c.data.startswith("delask_"))
async def delete_ask(call: types.CallbackQuery):
    if not await guard_admin_cb(call):
        return
    prod_id = int(call.data.split("_")[1])
    kb = InlineKeyboardMarkup().row(
        InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"delyes_{prod_id}"),
        InlineKeyboardButton("‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞", callback_data=f"delno_{prod_id}")
    )
    await call.message.answer(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä #{prod_id}?", reply_markup=kb)
    await call.answer()

@dp.callback_query_handler(lambda c: c.data.startswith("delyes_") or c.data.startswith("delno_"))
async def delete_do(call: types.CallbackQuery):
    if not await guard_admin_cb(call):
        return
    prod_id = int(call.data.split("_")[1])
    if call.data.startswith("delno_"):
        await call.message.answer("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        await call.answer()
        return
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("DELETE FROM catalog WHERE id=?", (prod_id,))
    conn.commit()
    conn.close()
    await call.message.answer(f"üóë –¢–æ–≤–∞—Ä #{prod_id} —É–¥–∞–ª—ë–Ω.")
    await call.answer()


@dp.message_handler(commands=["sql"])
async def sql_command(message: types.Message):
    if not admin_only(message):
        return await message.answer("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –í–≤–µ–¥–∏—Ç–µ /ap.")
    query = message.get_args()
    if not query:
        return await message.answer("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /sql SELECT * FROM orders;")
    try:
        conn = db_conn()
        cur = conn.cursor()
        cur.execute(query)
        if query.strip().upper().startswith("SELECT"):
            rows = cur.fetchall()
            if not rows:
                await message.answer("üì≠ –ü—É—Å—Ç–æ.")
            else:
                text = "\n".join(str(r) for r in rows[:20])
                if len(rows) > 20:
                    text += f"\n‚Ä¶ –∏ –µ—â—ë {len(rows) - 20} —Å—Ç—Ä–æ–∫(–∏)"
                await message.answer(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:\n\n{text}")
        else:
            conn.commit()
            await message.answer("‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω.")
        conn.close()
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ SQL: {e}")


async def auto_clear_old_orders():
    """–£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '–ü–æ–ª—É—á–µ–Ω' —Å—Ç–∞—Ä—à–µ 2 –¥–Ω–µ–π."""
    conn = db_conn()
    cur = conn.cursor()
    cur.execute("SELECT id, received_date FROM orders WHERE status=?", (STATUS_RECEIVED,))
    rows = cur.fetchall()
    now = datetime.now()
    removed = 0
    for oid, rdate in rows:
        if not rdate:
            continue
        try:
            dt = datetime.strptime(rdate, "%Y-%m-%d %H:%M:%S")
        except Exception:
            continue
        if now - dt > timedelta(days=2):
            cur.execute("DELETE FROM orders WHERE id=?", (oid,))
            removed += 1
    conn.commit()
    conn.close()
    if removed:
        logging.info(f"üóë –ê–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª–µ–Ω–æ {removed} –∑–∞–∫–∞–∑(–æ–≤).")

async def periodic_cleanup():
    # –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
    while True:
        try:
            await auto_clear_old_orders()
        except Exception as e:
            logging.exception(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∏: {e}")
        await asyncio.sleep(12 * 60 * 60)

async def on_startup(dp: Dispatcher):
    await auto_clear_old_orders()
    asyncio.create_task(periodic_cleanup())


if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True, on_startup=on_startup)
